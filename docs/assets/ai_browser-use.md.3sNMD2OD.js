import{_ as i,c as a,o as n,aB as t}from"./chunks/framework.DeK-WOGe.js";const l="/ai/browser-use-agent-decision.png",p="/ai/browser-use-parameter-error.png",c=JSON.parse('{"title":"让自动化测试Agent更好地代理你的浏览器","description":"","frontmatter":{},"headers":[],"relativePath":"ai/browser-use.md","filePath":"ai/browser-use.md"}'),h={name:"ai/browser-use.md"};function e(k,s,r,o,d,g){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="让自动化测试agent更好地代理你的浏览器" tabindex="-1">让自动化测试Agent更好地代理你的浏览器 <a class="header-anchor" href="#让自动化测试agent更好地代理你的浏览器" aria-label="Permalink to &quot;让自动化测试Agent更好地代理你的浏览器&quot;">​</a></h1><h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>在自动化测试领域，让AI Agent有效地操控浏览器一直是一个充满挑战的任务。Agent需要理解页面结构、执行交互操作、验证数据一致性，但往往会遇到决策不稳定、操作失败率高、调试困难等问题。</p><p>本文将介绍一个基于 CDP + Playwright + BrowserUse 的完整解决方案，通过精心设计的工具集和架构，让AI Agent能够更可靠、更智能地代理浏览器执行自动化测试任务。</p><h2 id="技术架构-cdp-playwright-browseruse-的完美结合" tabindex="-1">技术架构：CDP + Playwright + BrowserUse 的完美结合 <a class="header-anchor" href="#技术架构-cdp-playwright-browseruse-的完美结合" aria-label="Permalink to &quot;技术架构：CDP + Playwright + BrowserUse 的完美结合&quot;">​</a></h2><h3 id="为什么选择这个技术栈" tabindex="-1">为什么选择这个技术栈 <a class="header-anchor" href="#为什么选择这个技术栈" aria-label="Permalink to &quot;为什么选择这个技术栈&quot;">​</a></h3><ul><li><strong>CDP (Chrome DevTools Protocol)</strong>：Chrome浏览器的远程调试协议，也是我们日常使用的F12开发者工具的底层实现。通过CDP，我们可以程序化地实现所有DevTools的功能，如监听网络请求、执行JavaScript、操作DOM等</li><li><strong>Playwright</strong>：成熟的跨浏览器自动化框架，提供稳定的API和丰富的功能</li><li><strong>BrowserUse</strong>：为AI Agent设计的浏览器控制框架，提供了友好的Action接口</li></ul><h3 id="三者如何协同工作" tabindex="-1">三者如何协同工作 <a class="header-anchor" href="#三者如何协同工作" aria-label="Permalink to &quot;三者如何协同工作&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>           Chrome 浏览器</span></span>
<span class="line"><span>┌────────────────────────────────────┐</span></span>
<span class="line"><span>│  渲染引擎 (Blink)  │  JS引擎 (V8)    │</span></span>
<span class="line"><span>│────────────────────────────────────│</span></span>
<span class="line"><span>│        CDP Server (Port 9222)      │</span></span>
<span class="line"><span>└───────────────┬────────────────────┘</span></span>
<span class="line"><span>                │ WebSocket</span></span>
<span class="line"><span>     ┌──────────┼─────────┐</span></span>
<span class="line"><span>     │                    │</span></span>
<span class="line"><span>┌────▼─────┐        ┌─────▼─────┐</span></span>
<span class="line"><span>│Playwright│        │ BrowserUse│</span></span>
<span class="line"><span>└────┬─────┘        └─────┬─────┘</span></span>
<span class="line"><span>     │                    │</span></span>
<span class="line"><span>     └───────┐     ┌──────┘</span></span>
<span class="line"><span>             │     │</span></span>
<span class="line"><span>          ┌──▼──── ▼────┐</span></span>
<span class="line"><span>          │   AI Agent  │</span></span>
<span class="line"><span>          └─────────────┘</span></span></code></pre></div><p>实际的启动和连接流程：</p><ol><li><p><strong>启动Chrome并开启CDP</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 直接通过命令行启动Chrome，开启CDP服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chrome </span><span style="--shiki-light:#B31D28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic;">--</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">remote</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">debugging</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9222</span></span></code></pre></div><p>Chrome启动后，会在内部启动一个CDP服务器，监听9222端口</p></li><li><p><strong>Playwright和BrowserUse连接到CDP</strong></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Playwright通过CDP连接</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> playwright.chromium.connect_over_cdp(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[http://localhost:9222](http://localhost:9222)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># BrowserUse也连接到同一个CDP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BrowserSession(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cdp_url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[http://localhost:9222](http://localhost:9222)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div></li></ol><p>这样设计的好处是：Playwright和BrowserUse共享同一个浏览器实例，避免了资源浪费，同时可以充分利用两者的优势。</p><h3 id="cdp-devtools的幕后英雄" tabindex="-1">CDP：DevTools的幕后英雄 <a class="header-anchor" href="#cdp-devtools的幕后英雄" aria-label="Permalink to &quot;CDP：DevTools的幕后英雄&quot;">​</a></h3><p>值得一提的是，CDP正是我们日常开发中使用的F12开发者工具的底层实现。当你按下F12时：</p><ul><li><strong>Elements面板</strong> 使用 <code>DOM.getDocument</code>、<code>DOM.querySelector</code> 等CDP命令</li><li><strong>Console面板</strong> 使用 <code>Runtime.evaluate</code> 执行JavaScript</li><li><strong>Network面板</strong> 使用 <code>Network.enable</code> 监听网络请求</li><li><strong>断点调试</strong> 使用 <code>Debugger.setBreakpoint</code> 设置断点</li></ul><p>这就是为什么Playwright和BrowserUse能够实现如此强大的浏览器控制能力——它们本质上是通过程序化的方式使用&quot;开发者工具&quot;。</p><h2 id="核心能力一-智能的网络请求拦截与数据代理" tabindex="-1">核心能力一：智能的网络请求拦截与数据代理 <a class="header-anchor" href="#核心能力一-智能的网络请求拦截与数据代理" aria-label="Permalink to &quot;核心能力一：智能的网络请求拦截与数据代理&quot;">​</a></h2><h3 id="playwright网络监听的实现" tabindex="-1">Playwright网络监听的实现 <a class="header-anchor" href="#playwright网络监听的实现" aria-label="Permalink to &quot;Playwright网络监听的实现&quot;">​</a></h3><p>通过Playwright的网络监听能力，我们可以捕获所有的HTTP请求和响应：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 监听所有网络响应</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> on_response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(response: Response) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    event </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NetworkEvent(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        event_type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;response&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">response.request.method,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">response.url,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">response.status,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        headers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">response.headers</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 智能识别需要捕获的响应</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._should_capture_response_body(response.url):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        body </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> response.text()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        event.response_body </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> body</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 自动解析不同格式的数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._parse_response_data(response.url, body)</span></span></code></pre></div><h3 id="通用的响应数据捕获策略" tabindex="-1">通用的响应数据捕获策略 <a class="header-anchor" href="#通用的响应数据捕获策略" aria-label="Permalink to &quot;通用的响应数据捕获策略&quot;">​</a></h3><p>系统支持多种数据格式的自动识别和解析：</p><ol><li><strong>JSON API</strong>：标准的RESTful接口</li><li><strong>JSONP</strong>：带回调函数的跨域数据格式</li><li><strong>GraphQL</strong>：结构化查询语言响应</li><li><strong>Form Data</strong>：表单提交的结构化数据</li></ol><h3 id="封装为browseruse-tools供agent调用" tabindex="-1">封装为BrowserUse.Tools供Agent调用 <a class="header-anchor" href="#封装为browseruse-tools供agent调用" aria-label="Permalink to &quot;封装为BrowserUse.Tools供Agent调用&quot;">​</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查询网络接口数据，支持按URL关键词过滤&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query_network_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(keyword: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    通用的网络数据查询工具</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        keyword: URL关键词，用于过滤特定接口</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Returns:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        包含解析后数据的ActionResult</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 实现细节...</span></span></code></pre></div><h3 id="实际应用场景" tabindex="-1">实际应用场景 <a class="header-anchor" href="#实际应用场景" aria-label="Permalink to &quot;实际应用场景&quot;">​</a></h3><h3 id="示例-验证游戏背包数据" tabindex="-1">示例：验证游戏背包数据 <a class="header-anchor" href="#示例-验证游戏背包数据" aria-label="Permalink to &quot;示例：验证游戏背包数据&quot;">​</a></h3><p>在一个游戏活动测试中，Agent需要验证页面显示的背包物品是否与接口返回的数据一致：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Agent通过工具获取接口数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backpack_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query_network_data(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">keyword</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;listAward&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 自动解析JSONP格式</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># jsonpCallback123({&quot;awards&quot;: [{&quot;name&quot;: &quot;金币&quot;, &quot;count&quot;: 1000}]})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 解析后得到：{&quot;awards&quot;: [{&quot;name&quot;: &quot;金币&quot;, &quot;count&quot;: 1000}]}</span></span></code></pre></div><h2 id="核心能力二-精准的浏览器控制与状态管理" tabindex="-1">核心能力二：精准的浏览器控制与状态管理 <a class="header-anchor" href="#核心能力二-精准的浏览器控制与状态管理" aria-label="Permalink to &quot;核心能力二：精准的浏览器控制与状态管理&quot;">​</a></h2><h3 id="自动登录状态管理" tabindex="-1">自动登录状态管理 <a class="header-anchor" href="#自动登录状态管理" aria-label="Permalink to &quot;自动登录状态管理&quot;">​</a></h3><p>传统方式下，Agent需要自己找到登录入口、输入账号密码、处理验证码等复杂流程。我们提供了更直接的方案：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;执行自动登录。传入域名，自动完成登录流程&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_login_state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(domain: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 封装函数逻辑，请求接口获取免登录URL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    login_url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get_auto_login_url(domain)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 直接导航到免登录链接</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> playwright_page.goto(login_url)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 等待登录完成并记录状态</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asyncio.sleep(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ActionResult(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        extracted_content</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;登录已完成&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        metadata</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;login_url&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: login_url, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span></code></pre></div><h3 id="dom元素的智能操作" tabindex="-1">DOM元素的智能操作 <a class="header-anchor" href="#dom元素的智能操作" aria-label="Permalink to &quot;DOM元素的智能操作&quot;">​</a></h3><h3 id="可见性检测" tabindex="-1">可见性检测 <a class="header-anchor" href="#可见性检测" aria-label="Permalink to &quot;可见性检测&quot;">​</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;检查DOM元素是否在可视范围内&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> is_dom_visible</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dom_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    visibility_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> playwright_page.evaluate(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        (elementId) =&gt; {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            const element = document.getElementById(elementId);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            if (!element) return </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{exists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            const rect = element.getBoundingClientRect();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            const inViewport = (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                [rect.top](http://rect.top) &lt; window.innerHeight &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                rect.bottom &gt; 0 &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                rect.left &lt; window.innerWidth &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                rect.right &gt; 0</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            );</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            return {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                exists: true,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                visible: inViewport,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                position: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{top</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> [rect.top](http://rect.top), left: rect.left}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            };</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, dom_id)</span></span></code></pre></div><h3 id="智能滚动定位" tabindex="-1">智能滚动定位 <a class="header-anchor" href="#智能滚动定位" aria-label="Permalink to &quot;智能滚动定位&quot;">​</a></h3><p>当需要操作的元素不在视口内时，Agent经常会尝试多次滚动但仍然找不到目标。我们的工具确保一次成功：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;查找并滚动到指定元素，支持多个可能的ID&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_and_scroll_to_element</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dom_ids: list[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 依次尝试每个ID，找到第一个存在的元素</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dom_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> dom_ids:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        element </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> page.query_selector(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;#</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dom_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> element:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> element.scroll_into_view_if_needed()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ActionResult(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">success</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">found_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dom_id)</span></span></code></pre></div><h3 id="为什么这些操作不能完全依赖agent" tabindex="-1">为什么这些操作不能完全依赖Agent <a class="header-anchor" href="#为什么这些操作不能完全依赖agent" aria-label="Permalink to &quot;为什么这些操作不能完全依赖Agent&quot;">​</a></h3><p><img src="`+l+`" alt="Agent决策问题示意图" data-fancybox="gallery"></p><p>从实践中我们发现，当让Agent完全自主决策时，会出现以下问题：</p><ol><li><strong>重复尝试</strong>：Agent可能会多次尝试相同的操作，即使已经失败</li><li><strong>路径选择混乱</strong>：面对多种可能的操作路径，Agent的选择往往不是最优的</li><li><strong>错误恢复困难</strong>：一旦操作失败，Agent很难自动恢复到正确状态</li></ol><p>通过提供确定性的工具，我们将&quot;如何做&quot;的决策权从Agent转移到工具本身，Agent只需要决定&quot;做什么&quot;。</p><h2 id="核心能力三-可靠的tab管理体系" tabindex="-1">核心能力三：可靠的Tab管理体系 <a class="header-anchor" href="#核心能力三-可靠的tab管理体系" aria-label="Permalink to &quot;核心能力三：可靠的Tab管理体系&quot;">​</a></h2><h3 id="browseruse原生tab管理的局限性" tabindex="-1">BrowserUse原生Tab管理的局限性 <a class="header-anchor" href="#browseruse原生tab管理的局限性" aria-label="Permalink to &quot;BrowserUse原生Tab管理的局限性&quot;">​</a></h3><p>在使用BrowserUse的原生Tab管理功能时，我们遇到了一些问题：</p><ul><li><strong>关闭错误</strong>：尝试关闭Tab时可能会失败或关闭错误的Tab</li><li><strong>切换不稳定</strong>：切换到指定Tab的操作成功率不高</li><li><strong>黑盒操作</strong>：难以调试和追踪Tab状态，即使发生错误，我们也不知道是Agent调用的Tab id就是错误的，还是BrowserUse链接CDP导致内部某些异常</li></ul><h3 id="基于playwright的tab管理方案" tabindex="-1">基于Playwright的Tab管理方案 <a class="header-anchor" href="#基于playwright的tab管理方案" aria-label="Permalink to &quot;基于Playwright的Tab管理方案&quot;">​</a></h3><p>我们开发了一套更可靠的Tab管理工具：</p><h3 id="标记初始页" tabindex="-1">标记初始页 <a class="header-anchor" href="#标记初始页" aria-label="Permalink to &quot;标记初始页&quot;">​</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;标记当前Tab为初始活动页&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mark_current_tab_as_initial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(take_action</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    initial_tab_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get_current_page_target_id()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _browser_manager.initial_activity_tab_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initial_tab_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ActionResult(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">        extracted_content</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;已标记初始活动页: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">initial_tab_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span></code></pre></div><h3 id="批量清理外跳tab" tabindex="-1">批量清理外跳Tab <a class="header-anchor" href="#批量清理外跳tab" aria-label="Permalink to &quot;批量清理外跳Tab&quot;">​</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;关闭除初始页外的所有Tab并返回&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> close_all_tabs_and_return_to_initial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(take_action</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 获取所有Tab</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    all_tabs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get_all_tabs_info()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 关闭非初始页的Tab</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tab </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> all_tabs:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [tab.target](http:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">//</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tab.target)_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> initial_tab_id:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> close_tab([tab.target](http:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">//</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tab.target)_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 切换回初始页</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> switch_to_tab(initial_tab_id)</span></span></code></pre></div><h3 id="在prompt中强制使用tab-tools" tabindex="-1">在Prompt中强制使用Tab Tools <a class="header-anchor" href="#在prompt中强制使用tab-tools" aria-label="Permalink to &quot;在Prompt中强制使用Tab Tools&quot;">​</a></h3><p>通过在任务prompt中明确要求Agent使用特定的Tab管理工具，我们显著提高了任务成功率：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>任务步骤：</span></span>
<span class="line"><span>1. 使用 mark_current_tab_as_initial 标记当前页面</span></span>
<span class="line"><span>2. 点击所有外跳链接进行验证</span></span>
<span class="line"><span>3. 完成后必须使用 close_all_tabs_and_return_to_initial 返回</span></span></code></pre></div><h2 id="最佳实践-如何编写高效的测试任务" tabindex="-1">最佳实践：如何编写高效的测试任务 <a class="header-anchor" href="#最佳实践-如何编写高效的测试任务" aria-label="Permalink to &quot;最佳实践：如何编写高效的测试任务&quot;">​</a></h2><h3 id="工具选择策略" tabindex="-1">工具选择策略 <a class="header-anchor" href="#工具选择策略" aria-label="Permalink to &quot;工具选择策略&quot;">​</a></h3><ol><li><strong>确定性操作用工具</strong>：登录、滚动、Tab管理等</li><li><strong>探索性操作给Agent</strong>：查找元素、理解内容、做判断</li></ol><h3 id="prompt工程技巧" tabindex="-1">Prompt工程技巧 <a class="header-anchor" href="#prompt工程技巧" aria-label="Permalink to &quot;Prompt工程技巧&quot;">​</a></h3><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 好的prompt示例</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">prompt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1. 首先使用 get_login_state 确保已登录</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">2. 使用 query_network_data(keyword=&quot;listAward&quot;) 获取背包数据</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3. 对比页面显示和接口数据是否一致</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">4. 如果需要滚动，使用 find_and_scroll_to_element</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 避免的prompt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">avoid_prompt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1. 登录系统</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">2. 查看背包数据</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3. 验证数据一致性</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 太模糊，Agent需要自己决策太多细节</span></span></code></pre></div><h3 id="性能优化" tabindex="-1">性能优化 <a class="header-anchor" href="#性能优化" aria-label="Permalink to &quot;性能优化&quot;">​</a></h3><ul><li><strong>选择性捕获</strong>：只捕获需要的网络请求，避免内存溢出</li><li><strong>数据缓存</strong>：相同的请求不重复解析</li><li><strong>并行执行</strong>：多个独立的验证任务可以并行</li></ul><h3 id="browseruse-tools-定义的最佳实践" tabindex="-1">BrowserUse.Tools 定义的最佳实践 <a class="header-anchor" href="#browseruse-tools-定义的最佳实践" aria-label="Permalink to &quot;BrowserUse.Tools 定义的最佳实践&quot;">​</a></h3><p>在定义BrowserUse的自定义工具时，有一个重要的实践经验：</p><h3 id="为无参数工具添加默认参数" tabindex="-1">为无参数工具添加默认参数 <a class="header-anchor" href="#为无参数工具添加默认参数" aria-label="Permalink to &quot;为无参数工具添加默认参数&quot;">​</a></h3><p>当工具不需要任何参数就可以执行时，<strong>强烈建议添加一个无意义的默认参数</strong>。这是因为AI Agent在调用空参数工具时，经常会自作主张地添加一些不存在的参数，导致Pydantic模型校验失败。</p><p><img src="`+p+`" alt="Agent参数错误示意图" data-fancybox="gallery"></p><p>如图，<code>get_login_state</code> 不需要传递任何参数，但是Agent调用的时候调用的时候就是添加了<code>activity_id</code> 的参数，导致工具报错。</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ❌ 不好的定义</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;获取所有支持的域名列表&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_all_domains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Agent可能会传入 {&quot;_placeholder&quot;: &quot;&quot;} 导致错误</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pass</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ✅ 好的定义</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">@tools.action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;获取所有支持的域名列表&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_all_domains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(take_action: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bool</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; ActionResult:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    Args:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        take_action: 是否执行操作（默认True，兼容BrowserUse LLM行为模式的占位参数）</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 现在Agent可以传入 {&quot;take_action&quot;: true} 或空参数，都能正常工作</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    pass</span></span></code></pre></div><h3 id="其他工具定义建议" tabindex="-1">其他工具定义建议 <a class="header-anchor" href="#其他工具定义建议" aria-label="Permalink to &quot;其他工具定义建议&quot;">​</a></h3><ol><li><strong>明确的描述</strong>：工具描述应该清晰地说明工具的作用和使用场景</li><li><strong>结构化返回</strong>：使用ActionResult的metadata字段返回结构化数据，方便Agent解析</li><li><strong>错误处理</strong>：总是返回ActionResult，使用error字段传递错误信息，而不是抛出异常</li><li><strong>幂等性</strong>：尽量让工具具有幂等性，多次调用产生相同结果</li></ol><p>这些实践经验可以显著提高Agent调用工具的成功率，减少因参数验证失败导致的重试。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>通过CDP + Playwright + BrowserUse的技术组合，配合精心设计的工具集，我们成功解决了AI Agent在浏览器自动化测试中的诸多挑战：</p><ol><li><strong>网络数据透明化</strong>：Agent可以轻松获取和验证接口数据</li><li><strong>操作确定性</strong>：关键操作通过工具保证成功率</li><li><strong>Tab管理可控</strong>：解决了BrowserUse集成工具在该架构下使用不稳定问题</li><li><strong>效率大幅提升</strong>：相同任务所需的Agent数量和时间都大幅减少</li></ol><p>这套方案特别适合于：</p><ul><li>需要大量重复操作的回归测试</li><li>多语言、多环境的兼容性测试</li><li>数据一致性要求高的业务测试</li><li>复杂交互流程的端到端测试</li></ul><hr><p><em>本文介绍的完整代码实现可以在 <a href="https://github.com/Wadehl/browseruse-cdp-best-practise" target="_blank" rel="noreferrer">GitHub仓库</a> 获取。如果你在自动化测试中也遇到类似挑战，欢迎尝试这套方案。</em></p>`,81)])])}const y=i(h,[["render",e]]);export{c as __pageData,y as default};
