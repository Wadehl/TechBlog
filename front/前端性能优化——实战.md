---
layout: doc
outline: deep
---

# ç™½å±ä¼˜åŒ–

## ä¼˜åŒ–èƒŒæ™¯ (åŠ è½½æ—¶é—´å¯¹æ¯”)

```mermaid
pie
  "ç‚¹æ’­åå° 2.5-3s": 2.5
  "ç›´æ’­åå° 1.5-2.5s": 1.5
```

## ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–ç™½å±ï¼ˆFCPï¼‰æ—¶é—´

- å¢å¼ºç”¨æˆ·ä½“éªŒ
- æå‡é¡µé¢ç•™å­˜ç‡



## åˆ†æåŸå› 

### 1. äºŒè€…åŒºåˆ«

- ç‚¹æ’­åå°ä½¿ç”¨`Vue-Cli 4`ï¼Œè€Œç›´æ’­åå°ä½¿ç”¨`Vue-Cli 5`
- åœ¨åŠ è½½æµç¨‹ä¸Šï¼Œç‚¹æ’­åå°å…±æœ‰==295==æ¬¡è¯·æ±‚è€Œç›´æ’­åå°ä»…==53==æ¬¡è¯·æ±‚ï¼Œå…¶ä¸­ï¼Œ==295==æœ‰200+æ˜¯ç»†ç¢çš„`chunks`æ–‡ä»¶

### 2. åŸå› 

- ç»†ç¢`chunks`æå‰è¯·æ±‚é˜»å¡äº†é¡µé¢èµ„æºçš„è¯·æ±‚ä¸åŠ è½½ï¼Œè¿™äº›æ–‡ä»¶éƒ½é€šè¿‡`prefetch`è¿›è¡Œé¢„åŠ è½½ï¼Œå¯¼è‡´å…¶ä»–èµ„æºè¯·æ±‚å»¶å

- `chunks`ä½“ç§¯å¾ˆå°ï¼Œä½†æ˜¯æ•°é‡è¿‡å¤šï¼Œè€Œæµè§ˆå™¨ä¸€èˆ¬å¯¹åŒä¸€ä¸ª==åŸŸå==çš„è¯·æ±‚æœ‰æ‰€é™åˆ¶ï¼ˆChromeä¸€èˆ¬ä¸å¤šäº6ä¸ªï¼‰ï¼Œå¯¼è‡´ç­‰å¾…200å¤šä¸ªè¯·æ±‚éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´ã€‚

  ::: tips ä¸€ä¸ªè¡¥å……

  Chromeç¡®å®æ˜¯å¯¹åŒä¸€ä¸ªåŸŸåä¸‹çš„å¹¶å‘è¯·æ±‚çš„ä¸ªæ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸åŒçš„`GET/POST`è¯·æ±‚çš„é™åˆ¶ä¸º6ä¸ªï¼ˆä½¿ç”¨`HTTP/2.0+` æˆ–è€… `HTTPS`å³å¯çªç ´)ï¼Œè€Œ==åŒä¸€ä¸ª==`GET`è¯·æ±‚ï¼Œä¼šä¾æ¬¡ä¸€ä¸ªä¸€ä¸ªçš„æ‰§è¡Œã€‚

  ä½†æ˜¯å½“è¯·æ±‚é™æ­¢ç­‰å¾…==20s==åï¼Œè¿™äº›å‰©ä½™çš„ç›¸åŒ`GET`è¯·æ±‚ç…§æ ·ä¼šå¹¶å‘ã€‚è¿™é‡Œçš„åŸå› åœ¨äºï¼šChromeæµè§ˆå™¨çš„==getè¯·æ±‚ç¼“å­˜==ï¼Œå¯¹äºåŒä¸€ä¸ªURL+ç›¸åŒå‚æ•°å‘åå°å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœå‰ä¸€ä¸ªè¯·æ±‚æœªæ‰§è¡Œåä¸€ä¸ªè¯·æ±‚å°†è¢«é˜»å¡ï¼Œè€Œé˜»å¡çš„æ—¶é—´æœ€é•¿ä¸º==20s==ã€‚

  :::

- æœ‰çš„`JS`æ–‡ä»¶æ²¡æœ‰è¢«å‹ç¼©



## è§£å†³æ–¹æ¡ˆ

### 1. é’ˆå¯¹ç»†ç¢`chunks prefetch ` çš„æƒ…å†µ

::: tip

- ä»€ä¹ˆæ˜¯`prefetch`

  é¢„æå–(`prefetch`)æ˜¯ä¸€ç§æµè§ˆå™¨æœºåˆ¶ï¼Œåˆ©ç”¨æµè§ˆå™¨çš„==ç©ºé—²æ—¶é—´==åŠ è½½ç”¨æˆ·åœ¨å°†æ¥çš„ä¸ä¹…å¯èƒ½ä¼šè®¿é—®åˆ°çš„èµ„æºï¼Œå¹¶ä¸”ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚

  åœ¨å®é™…è°ƒç”¨çš„æ—¶å€™ï¼Œå¯ä»¥èŠ‚çœèµ„æºåŠ è½½çš„æ—¶é—´ã€‚

- ä¸ºä»€ä¹ˆä¼šå‡ºç°`prefetch`

  åŸå› åœ¨äº`Vue-Cli 4`é»˜è®¤å¼€å¯äº†`PreloadPlugin`æ’ä»¶ï¼Œä»–ä¼šæŠŠèµ„æºçš„linkæ·»åŠ `html`ä¸­ï¼Œå¹¶ä¸”æ·»åŠ ä¸Š`rel="prefetch"`ï¼Œè€Œ`Vue-Cli 5`æ˜¯é»˜è®¤å…³é—­çš„ã€‚

  ![image-20230504214109485](/image-20230504214109485.png)

- ä¸ºä»€ä¹ˆ`prefetch`ä¼šåœ¨é¡µé¢èµ„æºåŠ è½½å‰å»åŠ è½½å‘¢ ğŸ•µï¸

  è¿™ä¸æµè§ˆå™¨çš„åŠ è½½æœºåˆ¶ç›¸å…³ï¼Œ`ç©ºé—²æ—¶é—´`å®é™…ä¸ŠæŒ‡çš„æ˜¯==é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„é—´éš”æ—¶é—´==ï¼Œåœ¨è¿™ä¸ªæ—¶é—´ä¼šç”¨æ¥åŠ è½½ä½ä¼˜å…ˆçº§ä»»åŠ¡ã€‚è¿™ä¸ªæ—¶é—´å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æƒ³çš„ç­‰æ‰€æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡åŠ è½½å¥½åå†è¿›è¡ŒåŠ è½½ã€‚

  ![image-20230504214337410](/image-20230504214337410.png)

:::

#### æ–¹æ¡ˆï¼š

1. ç›´æ¥å…³é—­`preFetch`ï¼ˆä¸`Vue-Cli 5`ä¸€æ ·ï¼‰
2. åˆ©ç”¨å®šæ—¶å™¨ï¼Œå°†åŠ è½½çš„é¡ºåºæŒ‰ç…§æˆ‘ä»¬æ‰€æƒ³çš„é‚£æ ·åš



è¿™é‡Œè¯´ä¸€ä¸‹å¦‚ä½•å®ç°ç¬¬äºŒç§æ–¹æ³•ã€‚

::: tip å¦‚ä½•åˆ¤æ–­DOMæ˜¯å¦å·²ç»åŠ è½½æˆåŠŸï¼Ÿ

ä»¥ä¸‹æ–¹æ³•èƒ½å¤ŸæˆåŠŸè·å–åˆ°DOMå…ƒç´ åï¼Œè¯´æ˜é¡µé¢åŠ è½½å®Œæˆäº†

```js
addEvent(window, "load", function () {
	// ...
})

document

document.getElementByTagName('...')
document.getElementById('...')
document.querySelector('...')

document.body
```

- é€šè¿‡`è½®è¯¢`åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿè·å–åˆ°`DOM`ï¼Œå¦‚æœå·²ç»è·å–åˆ°æŸä¸ª`DOM`å…ƒç´ ï¼Œè¯´æ˜åŠ è½½å®Œæˆæ—¢å¯ä»¥åŠ è½½`prefetch`èµ„æº
- è¯¥`DOM`å…ƒç´ å¿…é¡»æ¯ä¸ªé¡µé¢éƒ½åŒ…å«

```js
//å»¶è¿ŸåŠ è½½prefetchèµ„æº
let timer =  setInterval(function() {
    //ç”±äº.p-live-admin-appè¢«è·å–åˆ°æ—¶é¡µé¢å·²åŠ è½½å®Œæˆï¼Œ
    //é€šè¿‡è½®è¯¢åˆ¤æ–­æ˜¯å¦æœ‰è¯¥å…ƒç´ æ¥åˆ¤æ–­é¡µé¢æ˜¯å¦åŠ è½½å®Œæˆ
    //ä»è€ŒåŠ è½½prefetch èµ„æº
	const lastChild =  document.querySelector('.p-live-admin-app');
    if (lastchild){
        loadChunks({
        chunks:['']
        assetTypes:['css','js'],
        prefetch:true,
        allChunkData
    	});
        window.clearInterval(timer);
        timer = null;
	}
},3000);
```

:::

â€‹	

### 2. é’ˆå¯¹è¿‡å¤šç»†ç¢`js/css`

#### æ–¹æ¡ˆï¼š

é€šè¿‡`WebPack`æ’ä»¶åœ¨æ‰“åŒ…æ—¶æŠŠç»†ç¢çš„`js`ä¸`css`åˆå¹¶ã€‚

é€šè¿‡`MinChunkSizePlugin`æ’ä»¶ï¼Œåˆå¹¶å°äº`minChunkSize`çš„æ–‡ä»¶ä¿æŒ`chunk`çš„æœ€å°å¤§å°ï¼Œå•ä½æ˜¯`Byte`ã€‚

```js
// webpack.config.js

// ...
this.minChunkSizePlugin = new webpack.optimize.minChunkSizePlugin({
    minChunkSize: this.minChunkSize,
})
```



### 3. é’ˆå¯¹æŸäº›`JS`æ–‡ä»¶æ²¡æœ‰å‹ç¼©

#### æ–¹æ¡ˆ

- æ‰‹åŠ¨ä½¿ç”¨æŒ‡ä»¤å‹ç¼©ä»£ç ï¼Œå¹¶ä¸”æ‰‹åŠ¨`inline`
- è‡ªå®šä¹‰æ’ä»¶å®ç°æ¯æ¬¡æ‰“åŒ…çš„æ—¶å€™è‡ªåŠ¨æ“ä½œ

###### å‹ç¼©: `terser | uglify`

```js
// terser
const fs = require('fs');
const { minify } = require('terser');
const result = minify(fs.readFileSync(file, 'utf-8'));

// uglify
const fs = require('fs');
const { minify } = require('uglify-js');
const result = minify(fs.readFileSync(file, 'utf-8'));
```

###### å†…è”ï¼šè·å–`HTML`åå°†`JS`æ”¾å…¥`body`åçš„`script`æ ‡ç­¾ä¸­

```js
inlineJs(optionPath, htmlData) {
    const str = minify(fs.readFileSync(optionPath, 'utf-8'), {}).code || ''; // optionPathä¸ºéœ€è¦å‹ç¼©å†…è”çš„JSçš„è·¯å¾„
    const scriptCode = `<script>${str}</script>` || '';
    const htmlStr = htmlData.html.toString();
    return htmlStr.replace(new RegExp('</body>', 'g'), scriptCode + '</body>'); // å†…è”è‡³bodyæœ€åé¢
    
}
```

###### å¤„ç†æ—¶æœºï¼šåœ¨`html-webpack-plugin`çš„`htmlWebpackPluginAfterHtmlProcessing`é’©å­ä¸­è·å–`html`

```js
compilation.hooks.htmlWebpackPluginAfterHtmlProcessing.tap
('GenTemplatePlugin',htmlData => {
    if (htmlData.plugin.options.meta.moreTemplateDisabled) return;
	htmlData.html = this.removeLink(htmlData);
	htmlData.html = this.inlineJs(this.loadPath, htmlData);
});
```



## ä»£ç æ€»ç»“

```js
const AssetsPlugin = require('assets-webpack-plugin');
const webpack = require('webpack');
const fs = require('fs');
const minify = require('terser');

class GenTemplatePlugin {
    constructor(options) {
        this.options = options || '';
        this.minChunkSize = this.options.minChunkSize;
        this.loadPath=this.options.loadPath; // loadAssets.jsæ–‡ä»¶çš„ä½ç½®
		this.outputPath=this,ptions.outputPath; // ç”Ÿæˆå¤šæ¨¡æ¿åŠ æˆªæ–‡ä»¶çš„ä½ç½®
        this.filename=this.options.filename;// ç”Ÿæˆå¤šæ¨¡æ¿åŠ è½½æ–‡ä»¶çš„åç§°
		this.resources=this.options.resources;// é™¤chunkå¤–çš„èµ„æºæ–‡ä»¶
		this.minChunkSizePlugin = new webpack.optimize.MinChunkSizePlugin({
    		minChunkSize: this.minChunkSize,
		});
		this.assetsPlugin = new AssetsPlugin({
    		filename:this.filename,
    		prettyPrint:false,
    		path:this.outputPath,
    		includeAllFileTypes:false
        });
    }
}
```

