---
layout: doc
outline: deep
---

# 

# 简单渲染前过程描述

## 大致流程

1. 用户输入域名，DNS解析域名为IP地址
2. 浏览器根据IP地址请求服务器
3. 服务器响应HTTP请求，并返回数据给浏览器
4. 浏览器开始渲染



## 具体细节：

1. 当用户输入域名URL后，浏览器进程（一般一个**标签页**对应一个**单独的进程**，但是一些空白页会被合并为一个进程）中的`UI线程`会建立一个`网络线程`，`网络线程`会根据`DNS`对域名进行**解析**获取`IP`（如果用户输入的是一些关键字/本地文件路径，就会到对应的搜索引擎/本地文件）。得到`IP`后，浏览器的`SafeBrowsing`会对`IP`进行安全检查（是否在黑名单），如果判定为不安全会提供一个<text style="color: red ">禁止访问</text>的页面，如果安全将与服务器进行通信（TCP三次握手，返回响应报文）通知`UI线程`进行下一步工作。

2. `UI线程`此时将新建一个`渲染进程`，并且通过`IPC`管道传输`HTML`文件给`渲染进程`的`主线程`，此时，正式开始渲染。



### 🏊‍♂️主线程

1. 在`主线程`中，会将`HTML`文件进行**词法分析**转义为`Token`，即`Tokenization`（标记化）

2. 并且创建`DOM节点`，最后创建成`DOM`树

   > 上述 1,2 被称为HTML解析

3. 但解析过程中，可能遇到`<link>与<style>`，就会涉及到CSS的解析（为了提升解析效率，浏览器在解析前会启动一个**预解析**，会优先下载`css`与`js`的资源文件。当`CSS`文件还未下载的时候，主线程并不会**阻塞**，这是因为`CSS`的下载与解析是在`预解析`线程中执行的，CSS解析完成后将生成`CSSOM`树。

   <img src="https://s2.loli.net/2023/04/12/HK6W4eGIp7gSRd3.png" alt="img" style="zoom: 50%;" />

4. 解析过程中，可能遇到`<script>`等标签，这就涉及到了`JS`的解析，而`JS`的解析会**阻塞**当前的`HTML`解析，在`JS`解释完毕后再继续，这是因为我们不清楚`JS`是否会操作`DOM`节点或者操作`CSS`节点。

   > 因此，我们需要注意JS的引入时间，一般JS的加载位置应该放在BODY标签的底部，或者使用`Defer`。

5. 此时，我们已经得到了解析好的`DOM`树与`CSSOM`树，此时进行`Computed Style`，得到一棵带有**样式**的`DOM`

6. 但是还不够，我们还需要得到`Layout`来获取每个节点的**几何信息**，通过这个计算过程后，我们将得到一棵带有页面`x,y坐标以及盒子尺寸`的`Layout Tree`，此时`Layout Tree`与我们真实能看到的内容是一一对应的了。

   > `Layout Tree`与`DOM`并非一一对应，其中不可视的`display: none`不会在`Layout Tree`上，而伪类元素(::before等)会挂载在`Layout Tree`的相应节点

7. 但是仍然不够，此时还需要注意，如果两个节点的位置大小有重合的话，我们无法确定哪个节点展示在前，哪个被覆盖，因此我们还需要确认各个节点的`绘制顺序`，即`分层`。

8. 分层工作完成后,将生成绘制指令，将每个层单独**生成**绘制指令。==只是生成，并未执行==

### 🏊‍♀️合成线程

9. 合成线程会先对图层进行分块处理得到`Tiles`（会从线程池获取**栅格线程**的帮助）

10. 分块完成后，将进行**光栅化**阶段，这一过程会交付给GPU进程，最终得到位图。

11. 最后，当所有的图块都被栅格化后，合成线程将生成一个个**指引quad**信息，并通过`IPC`给浏览器进程发送一个渲染帧，这个渲染帧最终将交由GPU进行显示，每当页面滚动的时候，合成线程都会交付另一个渲染帧给GPU来`更新页面`。

    > 指引会标识位图的位置，以及考虑旋转，缩放平移等信息，与**渲染主线程无关**。这就是为什么`transform`效率高的本质原因，以及不会引起`回流（重排）与重绘`阻塞渲染。





> ## 相关问题
>
> ### 1. Reflow 回流/重排
>
> ​	当进行影响`Layout Tree`的操作的时候，需要重新计算`Layout Tree`，而且为了避免连续的多次布局反复计算，浏览器会合并这些操作，当JS代码全部完成后再统一计算，改动属性造成的`Reflow`是异步完成的。也正因如此，JS获取布局属性的时候可能会无法获取到最新的布局信息。
>
> ### 2. Repaint 重绘
>
> ​	重绘，重新绘制渲染树，一般不影响DOM树，不一定引起回流，而回流一定引起重绘。

